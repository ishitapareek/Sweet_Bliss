<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sweet Bliss | Cart</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Amarante&family=Inknut+Antiqua:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" href="images/icon.png" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #fefcf7;
      color: #4a4a4a;
      line-height: 1.6;
      font-family: "Inknut Antiqua", serif;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 40px;
      background: #f9dbe3;
      border-bottom: 1px solid #e5b9c5;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .img-logo { width: 42px; height: 42px; }

    .logo-text {
      font-size: 1.7rem;
      font-weight: bold;
      color: #c94682;
      font-family: "Amarante";
      -webkit-text-stroke: 0.5px #98535E;
    }

    nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    nav a {
      text-decoration: none;
      color: #333;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid transparent;
      transition: 0.2s;
      display: flex;
      align-items: center;
    }

    nav a:hover,
    nav a.active {
      background: #fff;
      color: #c94682;
      border-color: #e5b9c5;
    }

    .cart-page-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 50px;
    }

    .cart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 15px;
      margin-bottom: 30px;
    }

    .cart-title {
      font-size: 2rem;
      font-family: "Amarante";
      color: #c94682;
    }

    .cart-item-count { font-weight: bold; }

    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .cart-item img {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      margin-right: 20px;
    }

    .item-info { flex-grow: 1; }

    .item-info h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .remove-item {
      font-size: 1.2rem;
      cursor: pointer;
      color: #888;
      transition: color 0.2s;
    }

    .remove-item:hover { color: #c94682; }

    .quantity-selector {
      display: flex;
      align-items: center;
      font-weight: bold;
      margin: 0 20px;
    }

    .quantity-selector button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #aaa;
    }

    .quantity-selector span { padding: 0 10px; }

    .item-price,
    .item-total {
      font-weight: bold;
      min-width: 80px;
      text-align: right;
    }

    .continue-shopping {
      display: inline-block;
      margin-top: 30px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
      transition: color 0.2s;
    }

    .continue-shopping:hover { color: #c94682; }

    .order-summary-panel {
      background: #f9dbe3;
      border: 1px solid #c94682;
      border-radius: 16px;
      padding: 30px;
    }

    .order-summary-panel h2 {
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 25px;
      font-family: "Amarante";
      color: #c94682;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 15px;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .promo-code-section { margin: 30px 0; }

    .promo-input-group {
      display: flex;
      border-radius: 8px;
      overflow: hidden;
    }

    .promo-input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-right: none;
      outline: none;
      font-size: 1rem;
    }

    .promo-input-group button {
      padding: 10px 20px;
      border: none;
      background: #e5b9c5;
      font-weight: bold;
      cursor: pointer;
    }

    .delivery-section select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background: #fff;
    }

    .summary-divider {
      border: 0;
      border-top: 1px solid #e0e0e0;
      margin: 25px 0;
    }

    .checkout-button {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      border: none;
      background: #c94682;
      color: white;
      font-size: 1.1rem;
      font-weight: bold;
      text-transform: uppercase;
      border-radius: 8px;
      cursor: pointer;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #f9dbe3;
      color: #555;
      border-top: 1px solid #e5b9c5;
      margin-top: 40px;
    }

    .popup {
      position: fixed;
      top: 30px;
      right: 30px;
      background: #c94682;
      color: #fff;
      padding: 14px 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(-15px);
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 2000;
      font-family: "Inknut Antiqua", serif;
    }

    .popup.show {
      opacity: 1;
      transform: translateY(0);
    }

    .popup.hidden {
      opacity: 0;
      transform: translateY(-15px);
    }

  </style>

</head>
<body>
  <%- include('partials/header') %>

  <main class="cart-page-container">
  <section class="cart-page">

   <div class="cart-header">
        <h1 class="cart-title">CART</h1>
        <span class="cart-item-count">3 Items</span>
      </div>
      <div class="cart-items"></div>

  <div id="cartContainer" class="cart-container"></div>

  <!-- <div class="summary-box"> -->
  
    <!-- <h2>Order Summary</h2> -->

    <!-- <div class="summary-row">
      <span>Subtotal:</span>
      <span id="subtotal">Rs.0</span>
    </div> -->
<!-- 
    <div class="summary-row">
      <span>Delivery:</span>
      <select id="delivery-options">
        <option value="0">Pickup (Free)</option>
        <option value="40">Home Delivery - Rs.40</option>
        <option value="80">Express Delivery - Rs.80</option>
      </select>
    </div>

    <div class="summary-row">
      <span>Promo Code:</span>
      <input type="text" id="promo-code" placeholder="Enter code" />
      <button id="apply-promo">Apply</button>
    </div> -->

    <!-- <hr class="summary-divider" />

    <div class="summary-row total">
      <span>Total:</span>
      <span id="total">Rs.0</span>
    </div>

    <button id="checkoutBtn" class="checkout-btn">Checkout</button> -->

  <!-- </div> -->
  <a href="/menu" class="continue-shopping">← Continue Shopping</a>

  </section>
  <aside class="order-summary-panel">
      <h2>Order Summary</h2>

      <div class="summary-line">
        <span>ITEMS</span>
        <span class="cart-item-count">3 Items</span>
      </div>

      <div class="promo-code-section">
        <label for="promo-code">Promo Code</label>
        <div class="promo-input-group">
          <input type="text" id="promo-code2" placeholder="Enter your code" />
          <button id="apply-promo2">APPLY</button>
        </div>
      </div>

      <div class="delivery-section">
        <label for="delivery2-options">Delivery</label>
        <select id="delivery2-options">
          <option value="100">Standard Delivery - Rs. 100</option>
          <option value="180">Express Delivery - Rs. 180</option>
          <option value="0">Store Pickup - Rs. 0</option>
        </select>
      </div>

      <hr class="summary-divider" />

      <div>
        <div class="summary-line"><span>Subtotal</span><span id="subtotal2">Rs.0</span></div>
        <div class="summary-line"><span>Promo Code</span><span id="promo2">Rs.0</span></div>
        <div class="summary-line"><span>Delivery</span><span id="delivery2">Rs.100</span></div>
        <div class="summary-line final-total"><span>Total Cost</span><span id="total2">Rs.0</span></div>
      </div>

      <button class="checkout-button">Checkout</button>
  </aside>
</main>

<div id="cartPopupMessage" class="popup hidden">
  <p id="cartPopupText"></p>
</div>

  <%- include('partials/footer') %>

</body>

</html>
<script>
  function showPopupMessage(text) {
    const popup = document.getElementById("cartPopupMessage");
    const message = document.getElementById("cartPopupText");

    message.textContent = text;

    popup.classList.remove("hidden");
    popup.classList.add("show");

    setTimeout(() => {
      popup.classList.remove("show");
      popup.classList.add("hidden");
    }, 1600);
  }


  class Cart {
    constructor(items) {
      this.items = items;
      this.deliveryCharge = 100;
      this.promoDiscount = 0;
    }

  render() {
    const container = document.getElementById("cartContainer");
    container.innerHTML = "";

    if (this.items.length === 0) {
      container.innerHTML = `<p class='empty-cart'>Your cart is empty.</p>`;
      this.updateSummary();
      return;
    }

    this.items.forEach((item) => {
      const card = document.createElement("div");
      card.classList.add("cart-item");

      card.innerHTML = `
        <img src="${item.image}" class="cart-img" />

        <div class="item-info">
          <h3>${item.name}</h3>
          <span class="remove-item" data-name="${item.name}">×</span>
        </div>

        <div class="quantity-selector">
          <button class="qty-change" data-name="${item.name}" data-action="decrease">−</button>
          <span class="qty-value">${item.quantity}</span>
          <button class="qty-change" data-name="${item.name}" data-action="increase">+</button>
        </div>

        <div class="item-price">Rs.${item.price}</div>
        <div class="item-total">Rs.${item.price * item.quantity}</div>

      
      `;

      container.appendChild(card);
    });

    this.bindEvents();
    this.updateSummary();
  }

  
  bindEvents() {
    document.querySelectorAll(".qty-change").forEach((btn) => {
      btn.addEventListener("click", () => {
        const name = btn.dataset.name;
        const action = btn.dataset.action;

        const item = this.items.find((i) => i.name === name);
        if (!item) return;

        if (action === "increase") {
          item.quantity++;
        } else if (action === "decrease" && item.quantity > 1) {
          item.quantity--;
        } else if (action === "decrease" && item.quantity === 1) {
          this.removeItem(name);
          return;
        }

        this.syncQuantity(name, item.quantity);
        this.render();
      });
    });

    document.querySelectorAll(".remove-item").forEach((btn) => {
      btn.addEventListener("click", () => {
        this.removeItem(btn.dataset.name);
      });
    });
  }

 
  removeItem(name) {
    this.items = this.items.filter((i) => i.name !== name);
    this.syncRemove(name);
    this.render();
  }

 
  applyPromo(code) {
    if (code === "SWEET10") {
      this.promoDiscount = 0.1;
    } else {
      this.promoDiscount = 0;
    }
    this.updateSummary();
  }

  updateSummary() {
    const subtotal = this.items.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    );

    const discount = subtotal * this.promoDiscount;
    const total = subtotal + this.deliveryCharge - discount;

    document.querySelectorAll(".cart-item-count").forEach(el => {
      el.textContent = `${this.items.length} Items`;
    });

    document.getElementById("subtotal2").textContent = `Rs.${subtotal}`;
    document.getElementById("promo2").textContent = `Rs.${discount}`;
    document.getElementById("delivery2").textContent = `Rs.${this.deliveryCharge}`;
    document.getElementById("total2").textContent = `Rs.${total}`;
  }

  
  syncQuantity(name, quantity) {
    fetch("/api/cart/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, quantity }),
    });
  }

  syncRemove(name) {
    fetch("/api/cart/item", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
      });
    }
  }


  fetch("/api/cart")
    .then((res) => {
      if (res.status === 401) {
    showPopupMessage("Please log in to view your cart.");
    setTimeout(() => {
      window.location.href = "/auth";
    }, 1500);
    return [];
  }

    return res.json();
  })

  .then((items) => {
    const cart = new Cart(items);
    cart.render();

    document.getElementById("delivery2-options").addEventListener("change", (e) => {
      cart.deliveryCharge = Number(e.target.value);
      cart.updateSummary();
    });

    document.getElementById("apply-promo2").addEventListener("click", () => {
      const code = document.getElementById("promo-code2").value;
      cart.applyPromo(code);
    });

    document.querySelector(".checkout-button").addEventListener("click", () => {
  showPopupMessage("Order placed successfully!");

  setTimeout(() => {
    fetch("/api/cart", { method: "DELETE" })
      .then(() => location.reload());
    }, 1500);
  });

  })
  
  .catch((err) => console.error("Error loading cart:", err));
</script>
